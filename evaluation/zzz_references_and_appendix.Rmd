```{r references, results = "asis", echo = FALSE}
# insert the references at this position
# set appendix = FALSE, when the report has no appendix
INBOmd::references(appendix = TRUE)
```

# Habitat types and subtypes in Flanders {#annex1}

```{r}

subtype_names <- read_types() %>%
  filter(typelevel == "subtype") %>%
  distinct(main_type, type, type_name) %>%
  rename(subtype = type, subtype_name = type_name)

main_types_names <- read_types() %>%
  filter(typelevel == "main_type") %>%
  distinct(typeclass_name, main_type, type_name)
  
table_types <- main_types_names %>%
  filter(!str_detect(main_type, "rbb")) %>%
  left_join(subtype_names, by = "main_type")

table_types %>%
  mutate(type_name = str_c(type_name, " (", main_type,")"),
         subtype_name = str_c(subtype_name, " (", subtype, ")")) %>%
  select("habitat category" = typeclass_name, "habitat type" = type_name, "habitat subtype" = subtype_name) %>%
  kable(booktabs = TRUE,
        longtable = TRUE,
        caption = "Habitat types and subtypes in Flanders", 
        format = format_table) %>%
  kable_styling(latex_options = c("scale_down"), font_size = 8) %>%
    column_spec(1, width = "0.5cm") %>%
    column_spec(c(2,3), width = "7cm") %>%
    collapse_rows(c(1, 2), row_group_label_position = 'stack')
  
```

# Power calculations using the `simr` package {#annexsimr}

## Methdodolgy

+ In a first step we use existing data from the Flemish Forest Inventory to fit a generalized linear mixed models, with plot as random effect to specify that the observations are paired. 
+ Model assumptions can be verified using the function `plotQQunif` of the `DHARMa` package [@hartig2022].
+ Next, we can use `simr` to modify the model by changing the sample size and effect size. For example, we can use the sample size and minimal detectable effect based on the paired t-test.
+ Finally `simr` estimates the power for the specified sample size and effect size based on a number of simulations.  

## Trend in proportions of favourable indicators of habitat type 9120

The following R code models the proportion of favourable indicators (prop_favourable) of habitat type 9120 for the different Forest Inventory periods using plot as a random effect:

`model_prop_favourable_9120 <- lmer(formula = prop_favourable ~ period + (1|plot), data = data_forest_paired)`

Proportions have values between 0 and 1 and in theory follow a zero- and one-inflated beta distribution. However, here we assume a normal distribution to avoid complexity. These model assumptions are quite OK, as can be seen in the figure below (generated by the function `plotQQunif`).

```{r , fig.height= 4}
plotQQunif(model_9120)
```

Table \@ref(tab:tabcompsimr1) shows the minimal difference in proportions of favourable indicators of habitat type 9120 that can be detected with a power of 0.80 according to the paired t-test, for different sample sizes. Table \@ref(tab:tabcompsimr1) also shows the estimated power based on `simr`. The power based on `simr` is close to 0.80 for all combinations of sample size and detectable difference, confirming the results from the paired t-test in Table \@ref(tab:tabdiffdetect1).     

```{r tabcompsimr1, cache= FALSE}

compare_power_aandeel_gunstig_9210 %>%
  mutate(power_simr = str_c(power_simr, " [", round(lcl, 2), " - ", round(ucl, 2), "]")) %>%
  mutate(power_pairedttest = 0.80) %>%
  select("sample size" = n, "detectable difference (%)" = effect_size, "power paired t-test"  = power_pairedttest, "power simr" = power_simr) %>%
  kable(caption = "Power ($\\pi$) based on paired t-test and estimated power using simr for the detectable difference in proportions of favourable indicators (habitat type 9120)", 
        digits = 2,
        booktabs = TRUE, 
        format = format_table) %>%
  kable_styling()
```

## Trend in number of key species of habitat type 9120

The following R code models the number of key species (n_keyspecies) of habitat type 9120 for the different Forest Inventory periods using plot as a random effect:

`model_keyspecies_9120 <- lmer(formula = n_keyspecies ~ period + (1|plot), data = data_forest_paired)`

The model assumptions are quite OK as can be seen in the figure below (generated by the function `plotQQunif`).

```{r , fig.height= 4}

plotQQunif(model_ks_9120_poisson)

```

Table \@ref(tab:tabcompsimr2) shows the minimal difference in the number of key species of habitat type 9120 that can be detected with a power of 0.80 according to the paired t-test, for different sample sizes. Table \@ref(tab:tabcompsimr2) also shows the estimated power based on `simr`. The power based on `simr` is significantly higher than 0.80 for all combinations of sample size and detectable difference. This indicates that slightly smaller differences in the number of key species can be detected with a power of 0.80 (for habitat type 9120) with the same sample size. The results from the paired t-test in Table \@ref(tab:tabmind) can therefore be regarded as a conservative indication of the minimal detectable difference.     

```{r tabcompsimr2, cache= FALSE}

compare_power_keyspecies_9210 %>%
  mutate(power_simr = str_c(power_simr, " [", round(lcl, 2), " - ", round(ucl, 2), "]")) %>%
  mutate(power_pairedttest = 0.80) %>%
  select("sample size" = n, "detectable difference (%)" = effect_size, "power paired t-test"  = power_pairedttest, "power simr" = power_simr) %>%
  kable(caption = "Power ($\\pi$) based on paired t-test and estimated power and 95\\% confidence interval using simr for the detectable difference in the number of key species (habitat type 9120)", 
        digits = 2,
        booktabs = TRUE, 
        format = format_table) %>%
  kable_styling()
```

## Trend in total cover of encroachment species of habitat type 9120

The following R code models the total cover of encroachment species (encroachment) of habitat type 9120 for the different Forest Inventory periods using plot as a random effect:

`model_encroachment_9120 <- lmer(formula = logit_encroachment ~ period + (1|plot), data = data_forest_paired)`

Like proportions, plant cover follows a zero- and one-inflated beta distribution. Modelling such distributions is quite complex and the `simr' package can not handle such models. However, assuming a normal distribution did not give good results. Therefore we first applied a logit transformation on the cover data:

$$\text{logit}(p)=\log\left(\frac{p}{1-p}\right)$$
The logit transformation of 0 and 1 is -Inf and +Inf. To avoid this we increased the zeroes with a small value of 0.001 and decreased the ones with 0.001 (0.999).

The model assumptions are still far from perfect but just pass the test. 

```{r , fig.height= 4}

plotQQunif(model_encroachement_9120)

```

Table \@ref(tab:tabcompsimr3) shows the minimal difference in the total cover of encroachment species of habitat type 9120, that can be detected with a power of 0.80 according to the paired t-test, for different sample sizes. Table \@ref(tab:tabcompsimr2) also shows the estimated power based on `simr`. The power based on `simr` is slightly lower for a sample size of 40 and slightly higher for a sample size of 170, but overall the results are comparable to those of the paired t-test.

```{r tabcompsimr3, cache= FALSE}

compare_power_encroachment_9210 %>%
  mutate(power_simr = str_c(power_simr, " [", round(lcl, 2), " - ", round(ucl, 2), "]")) %>%
  mutate(power_pairedttest = 0.80) %>%
  select("sample size" = n, "detectable difference (%)" = effect_size, "power paired t-test"  = power_pairedttest, "power simr" = power_simr) %>%
  kable(caption = "Power ($\\pi$) based on paired t-test and estimated power and 95\\% confidence interval using simr for the detectable difference in total cover of encroachment species (habitat type 9120)", 
        digits = 2,
        booktabs = TRUE, 
        format = format_table) %>%
  kable_styling()
```

# Habitat types and subtypes included in MHQ {#annex2} 

Table \@ref(tab:tabschemes) gives an overview of the habitat types for which a habitat quality monitoring scheme was developed. The table also provides the reason why a monitoring scheme was not considered the most appropriate approach for several habitat types. Terrestrial habitat types are considered very rare when the area is lower than 10 ha or when the habitat type occurs on less than 15 locations. The area and the number of locations was derived from the 2020 version of the Natura 2000 Habitat map [@desaeger2020].   

```{r tabschemes}

maintype_selection <- types_area_strata %>%
  mutate(area = round(area_type),
         sample_type = ifelse(sample_type, "yes", "no"),
         reden = ifelse(main_type %in% c("1310", "2110", "3270", "7150"), "very dynamic habitat type",
                        ifelse(main_type %in% c("1140"), "no habitat quality indicators available",
                               ifelse(main_type %in% c("1130"), "habitat quality evaluation on landsacpe scale",
                                      ifelse(main_type %in% c("6430"), "no accurate sample frame", 
                                             ifelse(main_type %in% c("9110"), "low priority", 
                                             ifelse(sample_type == "no" & (area <= 10 | n_polygons <= 15) , "very rare terrestrial type", ""))))))) %>%
  select("code type" = main_type, "area (ha)" = area,  "# locations" = n_polygons, "monitoring scheme" = sample_type, "reason" = reden) %>%
  unique()
  
maintype_selection %>%
  kable(caption = "Selection of the habitat types for which a monitoring scheme is implemented",
        booktabs = TRUE,
        longtable = TRUE, 
        format = format_table) %>%
  kable_styling(latex_options = c("repeat_header")) %>%
  column_spec(c(1,4), width = "1.5cm")

```




Table \@ref(tab:tabschemes2) gives an overview of which habitat subtypes are considered for oversampling. 

```{r tabschemes2}
subtype_selection <- types_area_strata %>%
  filter(typelevel == "subtype") %>%
  filter(sample_type) %>%
  mutate(area = round(area_subtype),
         extra_subtype = ifelse(extra_subtype, "yes", "no"),
         reason = ifelse(extra_subtype == "no" & (area <= 10 | n_polygons <= 15) , "very rare terrestrtial subtype", ""),
         extra_subtype = ifelse(type == "2190_mp", "yes", extra_subtype),
         reason = ifelse(type == "2190_mp", "oversampling applied in 1st monitoring cycle", reason)) %>%
  select("code type " = main_type,"code subtype" = type, "area (ha)" = area,  "# locations" = n_polygons_subtype, "oversampling" = extra_subtype, reason) %>%
  unique() 
  
subtype_selection %>%
  kable(caption = "Oversampling habitat subtypes",
        booktabs = TRUE, 
        format = format_table) %>%
  kable_styling() %>%
  collapse_rows(1)
```


# Sample size per habitat type and subtype {#annex3} 

Table \@ref(tab:tabsamplesizeterr) provides an overview per habitat type of:

+ total initial sample size for Flanders ($tot_{fl}$)
+ number of extra sampling units selected within the SAC ($extra_{sac}$)
+ number of extra sampling units selected per subtype ($extra_{subtype}$)
+ total overall sample size for the monitoring cycle
+ total overall sample size per year



```{r tabsamplesizeterr, eval=TRUE}

scenarios_subtype <- scenarios %>%
  filter(type_cat == "forest type" | scenario == "alternative 3") %>%
  filter(typelevel == "subtype", ) %>%
  select(main_type, subtype = type, n_extra_subtypes)

scenarios_main_type %>%
  filter(type_cat == "forest type" | scenario == "alternative 3") %>%
  arrange(main_type) %>%
  select("habitat type" = main_type, "cycle (years)" = cycle_years,  "tot fl" =  n_finite_flanders, "extra sac" =  n_extra_sac,  "extra subtype" =  n_extra_subtypes, "total per cycle" = n_total, "total per year" = n_total_year) %>%
  kable(booktabs = TRUE,
        caption = "Sample size per habitat type",
        align = "lccclccc",
        longtable = TRUE, 
        format = format_table) %>%
  kable_styling(latex_options = c("repeat_header")) %>%
  column_spec(c(1, 2, 3, 4), width = "1cm") %>%
  column_spec(c(5, 6, 7), width = "1.5cm") 
```


Table \@ref(tab:tabsamplesizeterrst) shows the number of extra sampling units per habitat subtype.

```{r tabsamplesizeterrst}
scenarios_subtype %>%
  arrange(main_type) %>%
  semi_join(scenarios_main_type, by = "main_type") %>%
  select("habitat type" = main_type, subtype,  "extra subtype" =  n_extra_subtypes) %>%
  kable(booktabs = TRUE,
        caption = "number of extra sampling units per habitat subtype", 
        format = format_table) %>%
  kable_styling() %>%
  collapse_rows(1)
```

